<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medidor de Metas</title>

    <!-- Manifest PWA -->
    <link rel="manifest" href="manifest.json">

    <!-- √çcono para la app -->
    <link rel="icon" type="image/png" href="icon.png">

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef1f5;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 430px;
            max-width: 95%;
        }

        h2, h3 {
            text-align: center;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        input {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 12px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .btn-green {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .btn-green:hover {
            background: #1e7e34;
        }

        /* Tarjetas compactas */
        .meta-card {
            background: white;
            padding: 12px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            box-shadow: 0 0 8px rgba(0,0,0,0.1);
        }

        .meta-info {
            display: flex;
            flex-direction: column;
        }

        .meta-title {
            font-weight: bold;
            font-size: 16px;
        }

        .meta-dates {
            font-size: 13px;
            color: #444;
        }

        .icon-hourglass {
            font-size: 26px;
        }

        .hint {
            font-size: 14px;
            color: #777;
            text-align: center;
            margin-top: -5px;
            padding-bottom: 10px;
        }

        .btn-delete {
            margin-left: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px;
            cursor: pointer;
        }
    </style>

</head>
<body>

<div class="container">

    <h2>üìå Medidor de Metas</h2>

    <!-- FORMULARIO -->
    <div id="formContainer" class="card">

        <label>Nombre de la meta:</label>
        <input id="metaNombre" type="text" placeholder="Ej: aprender ventas">

        <label>Fecha de inicio:</label>
        <input id="metaInicio" type="date">

        <label>Duraci√≥n (meses):</label>
        <input id="metaDuracion" type="number" min="1" placeholder="Ej: 4">

        <p class="hint">üìÖ La fecha de culminaci√≥n aparecer√° cuando inicies la meta ‚¨áÔ∏è</p>

        <button class="btn-green" onclick="agregarMeta()">Iniciar meta</button>
    </div>

    <h3>üóÇÔ∏è Mis metas</h3>
    <div id="listaMetas"></div>

    <!-- Bot√≥n para eliminar todas las metas -->
    <button class="btn-green" onclick="eliminarTodasMetas()">üóëÔ∏è Eliminar todas las metas</button>

</div>

<script>

    const listaMetas = document.getElementById("listaMetas");

    function agregarMeses(fecha, meses) {
        let f = new Date(fecha);
        f.setMonth(f.getMonth() + parseInt(meses));
        return f.toLocaleDateString("es-ES");
    }

    function agregarMeta() {
        const nombre = document.getElementById("metaNombre").value;
        const inicio = document.getElementById("metaInicio").value;
        const duracion = document.getElementById("metaDuracion").value;

        if (!nombre || !inicio || !duracion) {
            alert("Completa todos los campos para iniciar la meta.");
            return;
        }

        const fechaFin = agregarMeses(inicio, duracion);

        const card = document.createElement("div");
        card.className = "meta-card";
        card.dataset.nombre = nombre;
        card.dataset.fin = new Date(inicio).setMonth(new Date(inicio).getMonth() + parseInt(duracion));

        // Bot√≥n de eliminar meta individual
        card.innerHTML = `
            <div class="meta-info">
                <span class="meta-title">${nombre}</span>
                <span class="meta-dates">Inicio: ${new Date(inicio).toLocaleDateString("es-ES")}</span>
                <span class="meta-dates">Fin: ${fechaFin}</span>
            </div>
            <div class="icon-hourglass">‚è≥</div>
            <button class="btn-delete">‚ùå</button>
        `;

        listaMetas.appendChild(card);
        guardarMetas();
        asignarEventosEliminar();

        document.getElementById("metaNombre").value = "";
        document.getElementById("metaInicio").value = "";
        document.getElementById("metaDuracion").value = "";
    }

    // ==============================
    //   GUARDAR AUTOM√ÅTICO
    // ==============================
    function guardarMetas() {
        localStorage.setItem("metasGuardadas", listaMetas.innerHTML);
    }

    // ==============================
    //   ASIGNAR EVENTOS DE BORRAR
    // ==============================
    function asignarEventosEliminar() {
        document.querySelectorAll(".btn-delete").forEach(boton => {
            boton.onclick = function() {
                const card = boton.closest('.meta-card');
                if(card) {
                    card.remove();
                    guardarMetas();
                }
            }
        });
    }

    window.addEventListener("load", () => {
        const guardadas = localStorage.getItem("metasGuardadas");
        if (guardadas) {
            listaMetas.innerHTML = guardadas;
            asignarEventosEliminar(); // ahora los botones ‚ùå funcionan
        }
    });

    // ==============================
    //   ELIMINAR TODAS LAS METAS
    // ==============================
    function eliminarTodasMetas() {
        localStorage.removeItem("metasGuardadas");
        listaMetas.innerHTML = "";
    }

    // Observador para guardar cambios
    const observer = new MutationObserver(guardarMetas);
    observer.observe(listaMetas, { childList: true, subtree: true });

    // ==============================
    //   NOTIFICACIONES AUTOM√ÅTICAS
    // ==============================
    function verificarFechas() {
        document.querySelectorAll(".meta-card").forEach(meta => {
            const fechaFin = new Date(parseInt(meta.dataset.fin));
            const ahora = new Date();
            const diasFaltantes = Math.ceil((fechaFin - ahora) / (1000 * 60 * 60 * 24));

            if (diasFaltantes === 2) {
                if (window.electronAPI) {
                    window.electronAPI.enviarNotificacion(
                        "Tu meta est√° por terminar",
                        `Solo faltan 2 d√≠as para completar: ${meta.dataset.nombre}`
                    );
                } else {
                    console.log(`Notificaci√≥n: Solo faltan 2 d√≠as para: ${meta.dataset.nombre}`);
                }
            }
        });
    }

    setInterval(verificarFechas, 3600000); // cada hora

    // ==============================
    //   REGISTRAR SERVICE WORKER PWA
    // ==============================
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker registrado'))
        .catch(err => console.log('Error SW:', err));
    }

</script>

</body>
</html>

